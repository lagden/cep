#!/bin/bash

DIR="$( cd -P "$( dirname "$0" )" && pwd )"
cd $DIR
cd ..

abort() {
	printf "\n  \033[31mError: $@\033[0m\n\n" && exit 1
}

ok() {
	printf "\n  \033[32mOk: $@\033[0m\n\n"
}

_cleanup() {
	docker-compose down --volumes --remove-orphans > /dev/null 2>&1
	# docker rmi $(docker images --filter=reference='*:test' -q) > /dev/null 2>&1
}

trap '_cleanup; abort "Tests Failed For Unexpected Reasons"' HUP INT QUIT PIPE TERM SIGINT SIGTERM

docker-compose -f docker-compose.dev.yml up $1 --force-recreate test
if test $? -ne 0; then
	abort "Docker Compose Failed"
fi

TEST_EXIT_CODE=`docker inspect test --format='{{.State.ExitCode}}'`

_cleanup

test $TEST_EXIT_CODE -ne 0 && abort "Test FAIL" || ok "Test PASS"

exit $TEST_EXIT_CODE
